<div class="profile-container" *ngIf="!loading && user; else loadingOrError">
  <div class="profile-card">

    
   <img
  [src]="
    (editing && getPreviewImageUrl())
      ? getPreviewImageUrl()
      : (getProfileImageUrl(user?.profileImage) || '/profile-icon.svg')
  "
  alt="{{ user?.name || 'Profile Image' }}"
  title="{{ user?.name || 'Profile Image' }}"
  class="profile-image"
/>

    <div *ngIf="!editing; else editForm">
      <h2>{{ user?.name }}</h2>

      <p class="role-badge" *ngIf="user?.role">
        <strong>Role:</strong> {{ user.role | uppercase }}
      </p>

      <p *ngIf="user?.email"><strong>Email:</strong> {{ user.email }}</p>
      <p *ngIf="user?.major"><strong>Major:</strong> {{ user.major }}</p>
      <p *ngIf="user?.graduationYear"><strong>Graduation Year:</strong> {{ user.graduationYear }}</p>
      <p *ngIf="user?.bio"><strong>Bio:</strong> {{ user.bio }}</p>

      <!-- STUDENT SECTION -->
      <div class="role-section" *ngIf="user?.role === 'student'">
        <h3>Student Dashboard</h3>
        <p>You have standard student access.</p>
        <p>You can view announcements, submit maintenance requests, and use chat.</p>
      </div>

      <!-- RA SECTION -->
      <div class="role-section" *ngIf="user?.role === 'ra'">
        <h3>RA Assignment</h3>
        <p><strong>Building:</strong> {{ user?.raAssignment?.building || 'Not assigned' }}</p>
        <p><strong>Floor:</strong> {{ user?.raAssignment?.floor || 'Not assigned' }}</p>
      </div>

      <!-- ADMIN SECTION -->
      <div class="role-section" *ngIf="user?.role === 'admin'">
        <h3>Admin Access</h3>
        <button type="button" (click)="goToAdminLookup()">
          Open Admin User Lookup
        </button>
      </div>

      <button (click)="toggleEdit()">Edit Profile</button>
    </div>

    <ng-template #editForm>
      <h3>Edit Profile</h3>

      <form (ngSubmit)="saveChanges()">
        <input [(ngModel)]="updatedUser.name" name="name" placeholder="Name" />
        <input [(ngModel)]="updatedUser.email" name="email" placeholder="Email" />
        <input [(ngModel)]="updatedUser.major" name="major" placeholder="Major" />
        <input [(ngModel)]="updatedUser.graduationYear" name="graduationYear" placeholder="Graduation Year" />

        <label for="profileImage"><strong>Profile Image</strong></label>
        <input type="file" id="profileImage" (change)="onFileSelected($event)" />

        <img
          *ngIf="previewImage"
          [src]="previewImage"
          alt="Profile Preview"
          class="preview-image"
        />

        <button type="button" (click)="removeImage()" class="remove-btn">
          Remove Image
        </button>

        <textarea [(ngModel)]="updatedUser.bio" name="bio" placeholder="Bio"></textarea>

        <div class="buttons">
          <button type="submit">Save</button>
          <button type="button" (click)="toggleEdit()">Cancel</button>
        </div>
      </form>
    </ng-template>

  </div>
</div>

<ng-template #loadingOrError>
  <div class="profile-status">
    <p *ngIf="loading">Loading profile...</p>
    <p *ngIf="!loading && errorMessage">{{ errorMessage }}</p>
  </div>
</ng-template>